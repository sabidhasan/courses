<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Patatap</title>
    <script type="text/javascript">
      var circles = [];
    </script>
    <script type="text/javascript" src="node_modules/paper/dist/paper-full.js"></script>
    <script type="text/paperscript" canvas="canvas">
      var running;
      //contains objects with key data (what key pressed, when etc.);
      var keyData = {
        q: {sound: 'bubbles.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        w: {sound: 'clay.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        e: {sound: 'confetti.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        r: {sound: 'corona.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        t: {sound: 'dotted-spiral.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        y: {sound: 'flash-1.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        u: {sound: 'flash-2.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        i: {sound: 'flash-3.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        o: {sound: 'glimmer.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        p: {sound: 'moon.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        a: {sound: 'pinwheel.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        s: {sound: 'piston-1.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        d: {sound: 'piston-2.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        f: {sound: 'prism-1.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        g: {sound: 'prism-2.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        h: {sound: 'prism-3.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        j: {sound: 'splits.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        k: {sound: 'squiggle.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        l: {sound: 'strike.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        z: {sound: 'suspension.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        x: {sound: 'timer.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        c: {sound: 'ufo.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        v: {sound: 'veil.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        b: {sound: 'wipe.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        n: {sound: 'zig-zag.mp3', color: new Color(Math.random(), Math.random(), Math.random())},
        m: {sound: 'moon.mp3', color: new Color(Math.random(), Math.random(), Math.random())}
      }

      document.querySelector("footer").addEventListener("click", recall);

      function recall() {
        //check if running already
        if (running) return;

        //set running to true so cant run concurrently
        running = true;
        //offset is the setTimeout interval counter; innerCounter is used to count
        //which iteration of the timer we are on
        var offset = 0;
        var innerCounter = 0;

        //get latest ten circles
        var latestTen = circles.slice(Math.max(circles.length - 10, 0));
        var line = document.querySelector(".footer__line");

        var ms = 0;
        var to = setInterval(function() {
          ms += 10;
          //update line

          line.style.setProperty("left", (ms / totalTimeForLatestTen() * 100) + "%");
          if (ms > totalTimeForLatestTen()) clearInterval(to);
        }, 10)

        //loop through them setting the timer based on their percentage
        latestTen.forEach(function(val) {
            setTimeout(function() {
              //get list of original circles
              var originalCircle = circles[circles.length - (latestTen.length - innerCounter)];
              //update color, set finished state back to false
              originalCircle.circle.fillColor = keyData[val.key].color;
              originalCircle.circle.finished = false;
              //scale it to larger size (scale down is automatically handled by onFrame function)
              originalCircle.circle.scale(val.origSize * 5);
              //play sound
              originalCircle.circle.sound.play();
              //if this is the last iteration of the circles array, update running to false
              if (innerCounter === latestTen.length - 1) running = false;
              innerCounter++;
            }, offset);
            //update time offset (percentage is how much % time this keypress took
            // vs. total for last ten).
            offset += totalTimeForLatestTen() * (val.percentage / 100);
        });
      }

      function onKeyDown(e) {
          if (!(e.key in keyData) || running) return;

          var randWidth = Math.floor(Math.random() * view._bounds.width);
          var randHeight = Math.floor(Math.random() * view._bounds.height);
          var origSize = (Math.random() * 350) + 50;
          var paperCircle = new Path.Circle(new Point(randWidth, randHeight), origSize);
          paperCircle.fillColor = keyData[e.key].color;
          paperCircle.origSize = origSize;
          paperCircle.sound = new Audio(keyData[e.key].sound);
          paperCircle.sound.play();

          var circleObj = {
            "circle": paperCircle,
            "time": new Date(),
            "key": e.key,
            "origSize": origSize,
            "width": randWidth,
            "height": randHeight,
            "scaleFactor": (origSize - 2266.4) / -2333,
            "finished": false
          }
          circles.push(circleObj);

          //update UI
          var footer = document.querySelector(".footer__staff");


          var totalTime = totalTimeForLatestTen();

          circles = circles.map(function(val, idx) {
            val.percentage = circles[idx+1] ? parseFloat((circles[idx+1].time) - val.time) / totalTime * 100: 0
            return val;
          });

          footer.innerHTML = circles.map(function(val) {
            return "<span style='flex: 1 1 " + val.percentage + "%'>" + val.key + "</span>";
          }).join("");
      }

      function totalTimeForLatestTen() {
        var latestTen = circles.slice(Math.max(circles.length - 10, 0));
        return latestTen.map(function(val, idx) {
          return latestTen[idx+1] ? parseFloat((latestTen[idx+1].time) - val.time) : 0;
        }).reduce(function(acc, val) {return acc + val});
      }

      function onFrame(e) {
         for (var child in circles) {
           var currChild = circles[child];
           var state = currChild.circle.finished;
           var origSize = currChild.circle.origSize;
           var scaleFactor = currChild.scaleFactor;
           if (!state) {
             currChild.circle.scale(scaleFactor);
             currChild.circle.fillColor.hue += 1;
           }
           // delete child (were at the end of the loop so its ok)
           if (currChild.circle._bounds["000"].rect.width + currChild.circle._bounds["000"].rect.height < 1) {
             currChild.circle.finished = true;
           }
         }
       }
    </script>
    <style media="screen" type="text/css">
      * {box-sizing: border-box; margin: 0;}
      body, html {width: 100%; height: 100%; margin: 0; overflow: hidden;}
      body {display: flex; flex-direction: column;}
      canvas {width: 100%; flex: 1; background: black;}
      footer {
        height: 50px;  align-items: center;
        background: url(https://upload.wikimedia.org/wikipedia/commons/thumb/1/1f/Do_Mayor_armadura.svg/240px-Do_Mayor_armadura.svg.png), url(https://upload.wikimedia.org/wikipedia/commons/thumb/2/20/Music-staff.svg/200px-Music-staff.svg.png);
        font-size: 2rem; font-family: Baskerville, Times; text-transform: uppercase;
        background-repeat: no-repeat, repeat-x; background-size: contain;
        padding-left: 30px;
      }
      .footer__line {
        position: absolute;
        width: 3px;
        background: red;
        height: 100%;
      }
      .footer__staff span {
        display: none;
      }
      .footer__staff span:nth-last-child(-n+10) {
        display: inline;
      }
      .footer__staff {
        display: flex;
        flex: 1 1 100%;
      }
    </style>
    <!-- <link rel="stylesheet" href="styles.css" type="text/css"> -->
  </head>

  <body>
    <canvas id="canvas"></canvas>
    <footer>
      <span class="footer__line"></span>
      <div class="footer__staff"></div>
    </footer>

    <!-- <script type="text/javascript">

    </script> -->
  </body>
</html>
